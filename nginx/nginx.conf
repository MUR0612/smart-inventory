worker_processes  1;

events { worker_connections 1024; }

http {
  include       mime.types;
  sendfile      on;

  upstream inventory_upstream { server inventory-service:8001; }
  upstream order_upstream     { server order-service:8002; }

  server {
    listen 80;

    # 全域健康檢查
    location = /healthz { return 200 "ok\n"; }

    # ----- Inventory (保持原樣轉發) -----
    # 讓 /api/inventory/healthz 也能通到 /api/healthz
    location = /api/inventory/healthz {
      proxy_pass http://inventory_upstream/api/healthz;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/inventory/ {
      proxy_pass http://inventory_upstream;  # 不帶尾巴 /，避免改寫 URI
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    # ----- Orders (保持原樣轉發) -----
    # 讓 /api/orders/healthz 也能通到 /api/healthz
    location = /api/orders/healthz {
      proxy_pass http://order_upstream/api/healthz;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/orders/ {
      proxy_pass http://order_upstream;  # 不帶尾巴 /，避免改寫 URI
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }
  }
}
